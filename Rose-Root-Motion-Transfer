import maya.cmds as cmds

WINDOW_NAME = "ROSERootMotionUI"

def create_ui():
    if cmds.window(WINDOW_NAME, exists=True):
        cmds.deleteUI(WINDOW_NAME)

    cmds.window(WINDOW_NAME, title="ROSE Root Motion (UE5)", widthHeight=(330, 200))
    cmds.columnLayout(adjustableColumn=True, rowSpacing=8)

    cmds.text(label="Pelvis / Control Seç")
    cmds.rowLayout(nc=2, cw2=(220, 80))
    cmds.textField("controlField")
    cmds.button(label="Seç", command=select_control)
    cmds.setParent("..")

    cmds.text(label="Root Joint Seç")
    cmds.rowLayout(nc=2, cw2=(220, 80))
    cmds.textField("jointField")
    cmds.button(label="Seç", command=select_joint)
    cmds.setParent("..")

    cmds.separator(height=10)
    cmds.button(
        label="START - Root Motion Transfer",
        height=40,
        bgc=(0.25, 0.65, 0.25),
        command=transfer_root_motion
    )

    cmds.showWindow(WINDOW_NAME)


def select_control(*args):
    sel = cmds.ls(sl=True)
    if sel:
        cmds.textField("controlField", e=True, text=sel[0])


def select_joint(*args):
    sel = cmds.ls(sl=True)
    if sel:
        cmds.textField("jointField", e=True, text=sel[0])


def transfer_root_motion(*args):
    control = cmds.textField("controlField", q=True, text=True)
    root = cmds.textField("jointField", q=True, text=True)

    if not cmds.objExists(control) or not cmds.objExists(root):
        cmds.warning("Control veya Root geçerli değil!")
        return

    start = int(cmds.playbackOptions(q=True, min=True))
    end = int(cmds.playbackOptions(q=True, max=True))

    # --- İlk frame offset ---
    cmds.currentTime(start)
    base_tx = cmds.getAttr(f"{control}.translateX")
    base_tz = cmds.getAttr(f"{control}.translateZ")
    base_ry = cmds.getAttr(f"{control}.rotateY")

    # Root temizle
    cmds.cutKey(root, t=(start, end), clear=True)

    for frame in range(start, end + 1):
        cmds.currentTime(frame)

        tx = cmds.getAttr(f"{control}.translateX") - base_tx
        tz = cmds.getAttr(f"{control}.translateZ") - base_tz
        ry = cmds.getAttr(f"{control}.rotateY") - base_ry

        cmds.setKeyframe(root, at="translateX", v=tx, t=frame)
        cmds.setKeyframe(root, at="translateZ", v=tz, t=frame)
        cmds.setKeyframe(root, at="rotateY", v=ry, t=frame)

        # Kilitlenen eksenler (Unreal safe)
        cmds.setKeyframe(root, at="translateY", v=0, t=frame)
        cmds.setKeyframe(root, at="rotateX", v=0, t=frame)
        cmds.setKeyframe(root, at="rotateZ", v=0, t=frame)

    cmds.confirmDialog(
        title="Bitti",
        message="Root Motion başarıyla oluşturuldu!\n(UE5 uyumlu)",
        button=["OK"]
    )


create_ui()
